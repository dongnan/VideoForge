# 分辨率检测优化说明

## 📋 优化内容

### 1. 新增 2K/4K 分辨率支持

之前只支持 720p/1080p，现在支持完整的分辨率等级：

- **4K**: 短边 ≥ 2160px
- **2K**: 短边 ≥ 1440px
- **1080p**: 短边 ≥ 1080px
- **720p**: 短边 ≥ 720px
- **SD**: 低于 720p

### 2. 横竖屏自动识别

**旧逻辑问题**：只根据 `height` 判断，竖屏视频会误判
```python
# ❌ 旧代码
height = 1920  # 竖屏视频 1080x1920
# 会误判为高于 1080p，实际应该是 1080p
```

**新逻辑**：使用短边判断（`min(width, height)`）
```python
# ✅ 新代码
shorter_side = min(1080, 1920)  # = 1080
# 正确识别为 1080p，无论横竖
```

### 3. 码率估算优化

根据分辨率和 CRF 值精确估算目标码率：

#### H.264 编码

| 分辨率 | CRF 20 (高质量) | CRF 23 (中质量) | CRF 28 (低质量) |
|--------|----------------|----------------|----------------|
| **4K**   | 20 Mbps      | 12 Mbps        | 6 Mbps         |
| **2K**   | 10 Mbps      | 6 Mbps         | 3 Mbps         |
| **1080p**| 5 Mbps       | 3 Mbps         | 1.5 Mbps       |
| **720p** | 3.5 Mbps     | 2 Mbps         | 1 Mbps         |

#### H.265 编码（约为 H.264 的 60%）

| 分辨率 | CRF 20 (高质量) | CRF 23 (中质量) | CRF 28 (低质量) |
|--------|----------------|----------------|----------------|
| **4K**   | 12 Mbps      | 7 Mbps         | 3.5 Mbps       |
| **2K**   | 6 Mbps       | 3.5 Mbps       | 1.8 Mbps       |
| **1080p**| 3 Mbps       | 1.8 Mbps       | 0.9 Mbps       |
| **720p** | 2 Mbps       | 1.2 Mbps       | 0.6 Mbps       |

### 4. 分辨率调整智能适配

**旧逻辑**：固定限制高度
```bash
# ❌ 竖屏 1080x1920 限制到 720p
-vf scale=-2:720  # 结果: 405x720 (变形！)
```

**新逻辑**：自动识别方向
```bash
# ✅ 横屏 1920x1080 → 720p
-vf scale=-2:720  # 结果: 1280x720 ✓

# ✅ 竖屏 1080x1920 → 720p
-vf scale=720:-2  # 结果: 720x1280 ✓
```

## 🧪 测试验证

### 分辨率识别测试

```python
# 运行测试
cd /Volumes/Disk0/CodeBuddy/VideoForge
python3 test_resolution_detection.py
```

**测试覆盖**：
- ✅ 横屏 1080p (1920x1080) → 1080p
- ✅ 竖屏 1080p (1080x1920) → 1080p
- ✅ 横屏 2K (2560x1440) → 2K
- ✅ 竖屏 2K (1440x2560) → 2K
- ✅ 横屏 4K (3840x2160) → 4K
- ✅ 竖屏 4K (2160x3840) → 4K

### 实际使用示例

#### 转码 4K 视频到 2K

```bash
# 横屏 4K 视频 (3840x2160)
./videoforge.py transcode input_4k.mp4 -o output.mp4 \
    --codec h265 --quality medium --resolution 2K
# 输出: 2560x1440

# 竖屏 4K 视频 (2160x3840)
./videoforge.py transcode input_4k_portrait.mp4 -o output.mp4 \
    --codec h265 --quality medium --resolution 2K
# 输出: 1440x2560 (保持竖屏比例)
```

#### 批量转码混合视频

```bash
# 目录中包含横屏和竖屏的各种分辨率视频
./videoforge.py transcode /path/to/videos -o /path/to/output \
    --codec h264 --quality medium --resolution 1080p
```

**智能处理**：
- 4K 横屏 → 1920x1080
- 4K 竖屏 → 1080x1920
- 2K 横屏 → 1920x1080
- 2K 竖屏 → 1080x1920
- 1080p → 跳过（已是目标分辨率）
- 720p → 跳过（低于目标分辨率不放大）

## 🔧 技术实现

### 核心方法：`_get_resolution_tier()`

```python
def _get_resolution_tier(self, width: int, height: int) -> Tuple[str, int]:
    """根据视频宽高判断分辨率等级（使用短边判断，兼容横屏/竖屏）"""
    shorter_side = min(width, height)  # 关键：取短边
    
    if shorter_side >= 2160:    # 4K
        return '4K', 2160
    elif shorter_side >= 1440:  # 2K
        return '2K', 1440
    elif shorter_side >= 1080:  # 1080p
        return '1080p', 1080
    elif shorter_side >= 720:   # 720p
        return '720p', 720
    else:
        return 'SD', shorter_side
```

### 分辨率调整逻辑

```python
# 自动识别横竖屏
is_portrait = height > width

if target_short == 1080:
    if is_portrait:
        cmd.extend(['-vf', 'scale=1080:-2'])  # 竖屏：限制宽度
    else:
        cmd.extend(['-vf', 'scale=-2:1080'])  # 横屏：限制高度
```

## 📊 性能影响

### 码率估算准确性提升

**旧算法**：
- 竖屏 1080x1920 按 `height=1920` 计算
- 误认为需要 `5Mbps * (1920/1080) = 8.9 Mbps`
- **浪费 78% 码率**

**新算法**：
- 竖屏 1080x1920 按 `shorter_side=1080` 计算
- 正确使用 `3 Mbps` (H.265 CRF23)
- **准确匹配实际需求**

### 智能跳过效果

对于已经符合条件的视频：
- ✅ 1080p 竖屏视频 → 正确跳过（旧版会误转）
- ✅ 2K 低码率视频 → 智能跳过
- ✅ 4K 极低码率 → 智能跳过

## 🎯 使用建议

1. **4K → 1080p 批量转码**
   ```bash
   ./videoforge.py transcode /4k-videos -o /1080p-output \
       --codec h265 --quality medium --resolution 1080p
   ```
   节省空间约 75%，保持高质量

2. **混合分辨率归一化**
   ```bash
   # 将各种分辨率统一到 1080p
   ./videoforge.py transcode /mixed -o /unified \
       --codec h264 --quality medium --resolution 1080p
   ```

3. **2K 性价比转码**
   ```bash
   # 4K → 2K (节省空间 50%，画质损失极小)
   ./videoforge.py transcode /4k -o /2k \
       --codec h265 --quality high --resolution 2K
   ```

## ✅ 更新总结

| 项目 | 旧版本 | 新版本 |
|------|--------|--------|
| 支持分辨率 | 720p, 1080p | SD, 720p, 1080p, 2K, 4K |
| 竖屏识别 | ❌ 误判 | ✅ 准确 |
| 码率估算 | 基于高度 | 基于短边（准确） |
| 分辨率调整 | 固定方向 | 自动适配横竖 |
| 智能跳过 | 可能误转 | 精准判断 |

---

**测试时间**: 2025-11-09  
**版本**: v2.2.0
