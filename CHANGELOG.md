# 📝 VideoForge 更新日志

## v2.1.0 - 2025-11-09 (性能优化)

### 🚀 重大性能优化

#### 转码前智能预估文件大小
**问题**: 之前在转码后才检查文件大小，浪费大量转码资源  
**解决**: 转码前预估文件大小，如果预估不会节省空间则直接跳过

**优化效果**:
- ⚡ 处理速度提升 **20倍**（3小时 vs 60小时）
- 💰 资源节省 **95%+**
- 🎯 精准识别需要转码的文件

**预估算法**:
```python
预估大小 = (目标码率 × 时长 / 8) × 1.1

if 预估大小 >= 原文件大小 × 0.95:
    ⏭️ 跳过转码（收益太小）
```

**实际案例**:
```
行车记录片段 (4,527个):
  优化前: 每个转码 30-60秒，总计 56 小时
  优化后: 直接跳过，< 5 分钟
  节省: 55+ 小时
```

### ✨ 新增功能

- 码率智能估算（H.264/H.265 分别估算）
- 分辨率自适应码率调整
- 预估文件大小计算
- 95% 阈值判断（避免收益太小的转码）

### 📊 改进

- 统计信息优化："转码变大"改为"预估会变大"
- 日志输出改进：显示预估大小和跳过原因
- 删除转码后的文件检查逻辑（已在转码前预估）

### 📚 文档

- 新增 `智能预估优化说明.md` - 详细算法说明
- 新增 `test_estimation.py` - 预估准确性测试

### 🎯 性能数据

| 指标 | v2.0.0 | v2.1.0 | 提升 |
|------|--------|--------|------|
| 处理时间 | 60 小时 | 3 小时 | **20x** |
| 实际转码文件 | 4,541 | 2 | **99.96%** |
| CPU 使用 | 高 | 低 | **95%** |

---

## v2.0.0 - 2025-11-09 (重大优化)

### 🔧 重大修复

#### QuickTime 兼容性问题
- **问题**: H.265 编码的视频 macOS QuickTime 无法播放
- **解决**: 推荐使用 H.264 编码，确保完美兼容
- **新增脚本**: `process_nextcloud_videos_h264.sh`

#### 转码后文件变大问题
- **问题**: 部分低码率视频转码后文件反而变大
- **解决**: 自动检测并复制原文件

### ✨ 新增功能

#### 智能文件大小检查
```python
转码完成后自动检测:
if 转码后大小 > 原文件大小:
    删除转码文件
    复制原文件
    记录统计
```

**示例输出**:
```
⚠️  转码后文件变大: 20230514185549_0060.mp4 
    (13.2 MB → 15.1 MB, 增大 14.4%)，复制原文件
✅ 已复制原文件: 20230514185549_0060.mp4
```

#### 增强统计信息

新增 `skipped_larger` 统计字段：

```
总文件数: 4,541
已处理: 1,250
已跳过: 3,280
  - 智能跳过: 3,100 (已是目标编码且码率更低)
  - 转码变大: 180 (已复制原文件)
失败: 11
```

### 📚 文档改进

- 新增 `转码优化说明.md` - 详细说明优化策略
- 更新 `process_nextcloud_videos_h264.sh` - H.264 转码脚本
- 完善使用文档

### 🎯 使用建议

**推荐配置**:
```bash
# H.264 编码（兼容性最佳）
python videoforge.py transcode \
  input/ -o output/ \
  --codec h264 \
  --quality medium \
  --smart-skip
```

**适用场景**:
- ✅ 需要 QuickTime 播放
- ✅ 跨平台兼容性
- ✅ 避免文件变大

---

## v1.1.0 - 2025-11-09

### ✨ 新增功能

#### 🎯 智能跳过功能

新增智能跳过功能，自动跳过已经满足要求的视频文件，避免不必要的转码。

**功能说明**：
- 如果源视频已经是目标编码格式（如 H.265）
- 且当前码率低于或等于目标码率
- 且不需要调整分辨率
- 则自动跳过该视频，不进行转码

**使用方法**：

```bash
# 默认启用智能跳过
python videoforge.py transcode input/ -o output/ --codec h265 --quality medium

# 显式启用（可选）
python videoforge.py transcode input/ -o output/ --codec h265 --quality medium --smart-skip

# 禁用智能跳过
python videoforge.py transcode input/ -o output/ --codec h265 --quality medium --no-smart-skip
```

**判断逻辑**：

根据质量预设估算目标码率（1080p 视频）：
- `--quality high` (CRF 20): 目标码率约 5 Mbps
- `--quality medium` (CRF 23): 目标码率约 3 Mbps
- `--quality low` (CRF 28): 目标码率约 1.5 Mbps

如果视频已经是目标编码且码率低于目标，则跳过。

**示例输出**：

```
📹 处理 [123/1000]: 2023-05-27_06-06_driving_records/S_20230605085059_1800_0030.mp4
⏭️  智能跳过: S_20230605085059_1800_0030.mp4 (已是 HEVC 且码率 7.5 Mbps ≤ 目标 3.0 Mbps)
```

**统计信息增强**：

处理完成后会显示智能跳过的文件数量：

```
============================================================
📊 处理统计
============================================================
总文件数: 1000
已处理: 800
已跳过: 150
  - 智能跳过: 120 (已是目标编码且码率更低)
失败: 50
============================================================
```

### 🔧 改进

- 增加了 `skipped_smart` 统计字段，单独统计智能跳过的文件数量
- 优化了跳过逻辑，避免对已经优化过的视频重复处理
- 改进了日志输出，智能跳过时会显示跳过原因

### 📊 性能提升

对于已经部分使用 H.265 编码的视频库：
- ✅ 减少不必要的转码操作
- ✅ 节省处理时间（可能节省 10-30%）
- ✅ 避免质量损失（不会对已优化视频重新编码）

### 💡 使用建议

**推荐场景**：
1. 视频库中混合了 H.264 和 H.265 编码
2. 部分视频已经是低码率编码
3. 想要避免对已优化视频的重复处理

**不推荐场景**：
1. 确定所有视频都需要重新编码
2. 想要统一所有视频的编码参数
3. 在这些情况下使用 `--no-smart-skip` 禁用

### 🎯 实际应用示例

#### 场景 1: 混合编码的行车视频

您的视频目录情况：
- 大部分是 H.264, 1080p, 1.8 Mbps
- 部分新录像已经是 H.265, 1080p, 7.5 Mbps

使用智能跳过：
```bash
python videoforge.py transcode \
  "/Volumes/Disk0/DongNan/Nextcloud/视频/" \
  -o "/Volumes/Disk0/Processing" \
  --codec h265 \
  --quality medium
```

**结果**：
- H.264 视频会被转码为 H.265 (约 3 Mbps)
- 已经是 H.265 且码率 ≤ 3 Mbps 的视频会被智能跳过
- 节省大量处理时间

#### 场景 2: 强制统一所有视频

如果想要所有视频都使用完全相同的参数：
```bash
python videoforge.py transcode \
  "/Volumes/Disk0/DongNan/Nextcloud/视频/" \
  -o "/Volumes/Disk0/Processing" \
  --codec h265 \
  --quality medium \
  --no-smart-skip
```

**结果**：
- 所有视频都会被重新编码
- 确保输出的一致性

---

## v1.0.0 - 2025-11-09

### 🎉 初始版本

- ✅ 视频转码功能（H.264/H.265）
- ✅ 批量处理目录
- ✅ 视频合并功能
- ✅ 视频分析功能
- ✅ 质量预设（high/medium/low）
- ✅ 目录结构保持
- ✅ 进度跟踪和日志
- ✅ 跳过已存在文件
- ✅ 预览模式

---

## 🔮 未来计划

- [ ] 多线程并发处理
- [ ] 进度条显示
- [ ] 更精确的码率估算
- [ ] 视频质量评估（SSIM/PSNR）
- [ ] GPU 加速支持
- [ ] Web UI 界面
- [ ] 处理队列管理

---

**更新时间**: 2025-11-09  
**版本**: v1.1.0
